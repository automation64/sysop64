#!/usr/bin/env bash
# template-module-lib: 2.2.0
#######################################
# Copyright SerDigital64 - https://github.com/serdigital64
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at: http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#######################################

#
# Imports
#

# shellcheck disable=SC2015,SC2154 source-path=/opt/bl64
source "${S64_CORE_PATH_BL64}/bashlib64-module-log.bash" &&
  source "${S64_CORE_PATH_BL64}/bashlib64-module-fs.bash" &&
  source "${S64_CORE_PATH_BL64}/bashlib64-module-txt.bash" &&
  source "${S64_CORE_PATH_BL64}/bashlib64-module-xsv.bash" &&
  source "${S64_CORE_PATH_BL64}/bashlib64-module-fmt.bash" &&
  source "${S64_CORE_PATH_BL64}/bashlib64-module-ui.bash" &&
  source "${S64_CORE_PATH_BL64}/bashlib64-module-bsh.bash" ||
  { s64_core_lib_check_bl64_load && exit 1; }

#
# Module parameters
#

# shellcheck disable=SC2034
{
  declare S64_RSYNC_PATH_CLI="${S64_RSYNC_PATH_CLI:-}"
}

#
# Globals
#

# shellcheck disable=SC2034
{
  declare S64_RSYNC_VERSION='4.1.0'

  # RSync / Common parameters, regardless of the method
  declare S64_RSYNC_SET_COMMON=''
  S64_RSYNC_SET_COMMON+=' --checksum'    # skip based on checksum, not mod-time & size
  S64_RSYNC_SET_COMMON+=' --mkpath'      # create destination's missing path components
  S64_RSYNC_SET_COMMON+=' --preallocate' # allocate dest files before writing them

  # RSync / Common parameters for CIFS
  declare S64_RSYNC_SET_CIFS=''
  S64_RSYNC_SET_CIFS+=' --no-links'
  S64_RSYNC_SET_CIFS+=' --no-perms'
  S64_RSYNC_SET_CIFS+=' --no-acls'
  S64_RSYNC_SET_CIFS+=' --no-owner'
  S64_RSYNC_SET_CIFS+=' --no-group'
  S64_RSYNC_SET_CIFS+=' --no-devices'

  # RSync / Parameters for local operation
  declare S64_RSYNC_SET_LOCAL=''
  S64_RSYNC_SET_LOCAL+=' --one-file-system' # don't cross filesystem boundaries

  # RSync / Parameters for remote operation
  declare S64_RSYNC_SET_REMOTE=''
  S64_RSYNC_SET_REMOTE+=' --compress'         # compress file data during the transfer
  S64_RSYNC_SET_REMOTE+=' --compress-level=9' # explicitly set compression level

  # RSync / Parameters for copy method
  declare S64_RSYNC_SET_COPY=''
  S64_RSYNC_SET_COPY+=' --recursive' # recurse into directories
  S64_RSYNC_SET_COPY+=' --links'     # copy symlinks as symlinks
  S64_RSYNC_SET_COPY+=' --perms'     # preserve permissions

  # RSync / Parameters for sync method
  declare S64_RSYNC_SET_SYNC=''
  S64_RSYNC_SET_SYNC+=' --recursive' # recurse into directories
  S64_RSYNC_SET_SYNC+=' --links'     # copy symlinks as symlinks
  S64_RSYNC_SET_SYNC+=' --perms'     # preserve permissions
  S64_RSYNC_SET_SYNC+=' --delete'    # delete extraneous files from dest dirs

  # RSync / Parameters for clone method
  declare S64_RSYNC_SET_CLONE=''
  S64_RSYNC_SET_CLONE+=' --recursive'    # recurse into directories
  S64_RSYNC_SET_CLONE+=' --delete'       # delete extraneous files from dest dirs
  S64_RSYNC_SET_CLONE+=' --owner'        # preserve owner (super-user only)
  S64_RSYNC_SET_CLONE+=' --group'        # preserve group
  S64_RSYNC_SET_CLONE+=' --links'        # copy symlinks as symlinks
  S64_RSYNC_SET_CLONE+=' --perms'        # preserve permissions
  S64_RSYNC_SET_CLONE+=' --times'        # preserve modification times
  S64_RSYNC_SET_CLONE+=' --atimes'       # preserve access (use) times
  S64_RSYNC_SET_CLONE+=' --open-noatime' # avoid changing the atime on opened files

  # RSync / Optional parameters. Must be enabled at compile time
  S64_RSYNC_SET_CLONE_OPT+=' --crtimes'  # preserve create times (newness)
}

#
# Functions
#

function s64_rsync_lib_setup() {
  bl64_dbg_app_show_function
  s64_core_lib_command_assign 'S64_RSYNC_PATH_CLI' 'rsync'
}

function s64_rsync_lib_run_rsync() {
  bl64_dbg_app_show_function "$@"
  local verbose_flag='--human-readable --verbose --stats --progress'
  bl64_check_command "$S64_RSYNC_PATH_CLI" "$BL64_VAR_DEFAULT" 'S64_RSYNC_PATH_CLI' || return $?
  bl64_msg_app_detail_is_enabled || verbose_flag=' '
  bl64_dbg_app_trace_start
  # shellcheck disable=SC2086
  "$S64_RSYNC_PATH_CLI" \
    $verbose_flag \
    "$@"
  bl64_dbg_app_trace_stop
}
